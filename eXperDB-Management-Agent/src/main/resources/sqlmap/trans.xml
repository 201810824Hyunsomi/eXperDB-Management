<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="trans">
	<select id="selectPrySvrInfo" parameterType="ProxyServerVO" resultType="ProxyServerVO">
   		/**
	 	* Query ID : updateTransExe
	 	* Description : 데이터전송 결과 수정
	 	* Author :
	 	**/       
        UPDATE T_TRANSCNG_I
           SET EXE_STATUS = #{exe_status},
           		LST_MDF_DTM = clock_timestamp()
         WHERE 1 = 1
           AND TRANS_ID = #{trans_id}
	</update>

	<update id="updateTransTargetExe" parameterType="TransVO">
   		/**
	 	* Query ID : updateTransTargetExe
	 	* Description : 데이터전송 결과 수정
	 	* Author :
	 	**/         
        UPDATE T_TRANSCNG_TARGET_I
           SET EXE_STATUS = #{exe_status}
           	   LST_MDF_DTM = clock_timestamp()
         WHERE 1 = 1
           AND TRANS_ID = #{trans_id}
	</update>

	<select id="selectTransComSettingInfo" parameterType="TransVO" resultType="TransVO">
   		/**
	 	* Query ID : selectTransComSettingInfo
	 	* Description : TRANS 공통 설정
	 	* Author : 
	 	**/
       SELECT A.TRANS_COM_ID,
              A.PLUGIN_NAME,
              A.HEARTBEAT_INTERVAL_MS,
              A.HEARTBEAT_ACTION_QUERY,
              A.MAX_BATCH_SIZE,
              A.MAX_QUEUE_SIZE,
              A.OFFSET_FLUSH_INTERVAL_MS,
              A.OFFSET_FLUSH_TIMEOUT_MS,
              A.AUTO_CREATE,
              A.TRANSFORMS_YN
         FROM T_TRANSCOMCNG_I A
        WHERE A.TRANS_COM_ID = #{trans_com_id}::numeric
        LIMIT 1
	</select>
	
	<select id="selectTablePkInfo" parameterType="TransVO" resultType="TransVO">
		<![CDATA[
		/**
	 	* Query ID : selectTablePkInfo
	 	* Description : Database pk 조회
	 	* Author : 박태혁
	 	**/
       SELECT CC.COLUMN_NAME AS COLUMN_NAME
         FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS       TC
             ,INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE CC
        WHERE TC.TABLE_NAME      = #{table_name}
          AND TC.CONSTRAINT_TYPE = 'PRIMARY KEY'
          AND TC.TABLE_CATALOG   = CC.TABLE_CATALOG
          AND TC.TABLE_SCHEMA    = CC.TABLE_SCHEMA
          AND TC.TABLE_NAME      = CC.TABLE_NAME
          AND TC.CONSTRAINT_NAME = CC.CONSTRAINT_NAME
		]]>
	</select>

    <insert id="insertTransTopic"  parameterType="TransVO">
    	/**
	 	* Query ID : insertTransTopic
	 	* Description : source connect 활성화 topic 등록
	 	* Author : 
	 	**/
        INSERT INTO T_TRANS_TOPIC
                    (
                     TOPIC_ID,
                     TOPIC_NM, 
                     SRC_TRANS_EXRT_TRG_TB_ID, 
                     SRC_TRANS_ID, 
                     TABLE_TOTAL_CNT, 
                     FRST_REGR_ID, 
                     FRST_REG_DTM, 
                     LST_MDFR_ID, 
                     LST_MDF_DTM
                    )
                    SELECT
                           nextval('q_t_transcng_i_01'),
                           #{topic_nm},
                           (SELECT COALESCE(TRANS_EXRT_EXCT_TB_ID,0) FROM  T_TRANSCNG_I WHERE TRANS_ID = #{trans_id} LIMIT 1),
                           #{trans_id},
                           (select COALESCE(table_total_cnt,0)
                             from t_trans_exrttrg_mapp
                            where trans_exrt_trg_tb_id = (SELECT COALESCE(TRANS_EXRT_EXCT_TB_ID,0) FROM  T_TRANSCNG_I WHERE TRANS_ID = #{trans_id} LIMIT 1)
                            LIMIT 1),
                           'system',
                           clock_timestamp(),
                           'system',
                           clock_timestamp()
    </insert>
</mapper>