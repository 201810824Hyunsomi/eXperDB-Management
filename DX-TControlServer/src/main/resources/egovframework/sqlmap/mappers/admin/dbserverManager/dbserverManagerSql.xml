<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dbserverManagerSql">

	<select id="selectDbListTree" resultType="dbVO" parameterType="int">
		/**
	 	*  Query ID : selectDbListTree
	 	* Description : DB서버 리스트 조회
	 	* Author : 변승우
	 	**/    
          SELECT 
                  (ROW_NUMBER() OVER()) AS ROWNUM
				, (ROW_NUMBER() OVER()) AS IDX
				, DB_SVR_ID
                , DB_ID
                , DB_NM
                , DB_USR_ID
                , DB_EXP
                , USEYN
				, FRST_REGR_ID
				, TO_CHAR(FRST_REG_DTM,'YYYY-MM-DD HH24:MI:SS') AS FRST_REG_DTM
				, LST_MDFR_ID
				, TO_CHAR(LST_MDF_DTM,'YYYY-MM-DD HH24:MI:SS') AS LST_MDF_DTM
          FROM T_DB_I
          WHERE DB_SVR_ID = #{db_svr_id}
	</select>


	<select id="selectDbServerList" resultType="dbServerVO">
		/**
	 	*  Query ID : selectDbServerList
	 	* Description : DB서버 리스트 조회
	 	* Author : 변승우
	 	**/
	 	
	  SELECT
      		(ROW_NUMBER() OVER()) AS ROWNUM
			, (ROW_NUMBER() OVER()) AS IDX
			, AA.DB_SVR_ID
			, AA.DB_SVR_NM
			, AA.IPADR
			, AA.PORTNO
			, AA.DFT_DB_NM
			, AA.SVR_SPR_USR_ID
			, AA.SVR_SPR_SCM_PWD
			, AA.PGHOME_PTH
			, AA.PGDATA_PTH
			, AA.USEYN
			, AA.AGT_CNDT_CD
			, AA.SOCKET_PORT
			, AA.FRST_REGR_ID
			, AA.FRST_REG_DTM
			, AA.LST_MDFR_ID
			, AA.LST_MDF_DTM
      FROM(      
          SELECT 
                 A.DB_SVR_ID
                , A.DB_SVR_NM
                , A.IPADR
                , A.PORTNO
                , A.DFT_DB_NM
                , A.SVR_SPR_USR_ID
                , A.SVR_SPR_SCM_PWD
                , A.PGHOME_PTH
				, A.PGDATA_PTH
				, A.FRST_REGR_ID
				, A.USEYN
				, B.AGT_CNDT_CD
				, B.SOCKET_PORT
				, TO_CHAR(A.FRST_REG_DTM,'YYYY-MM-DD HH24:MI:SS') AS FRST_REG_DTM
				, A.LST_MDFR_ID
				, TO_CHAR(A.LST_MDF_DTM,'YYYY-MM-DD HH24:MI:SS') AS LST_MDF_DTM
          FROM T_DBSVR_I	A, T_AGTCNDT_I B
          WHERE 1 = 1
          AND A.IPADR = B.IPADR
  	      <if test="db_svr_id != null and db_svr_id != '' and db_svr_id != 0">
	      AND DB_SVR_ID = #{db_svr_id}
	      </if>	         
	      <if test="db_svr_nm != null and db_svr_nm != ''">
	      AND DB_SVR_NM LIKE '%' || #{db_svr_nm} || '%'
	      </if>	     
	      <if test="ipadr != null and ipadr != ''">
	      AND IPADR LIKE '%' || #{ipadr} || '%'
	      </if>	      
	      <if test="dft_db_nm != null and dft_db_nm != ''">
	      AND DFT_DB_NM LIKE  '%' || #{dft_db_nm} || '%'
	      </if>   
	      <if test="useyn != null and useyn != ''">
	      AND USEYN LIKE  '%' || #{useyn} || '%'
	      </if>      
          ORDER BY DB_SVR_ID
      ) AA		
    </select>
    
    
    <insert id="insertDbServer" parameterType="dbServerVO">
    	/**
	 	*  Query ID : insertDbServer
	 	* Description : insertDbServer 등록
	 	* Author : 변승우
	 	**/
	 	
		INSERT INTO T_DBSVR_I
		(
			  DB_SVR_ID
			, DB_SVR_NM
			, IPADR
			, PORTNO
			, DFT_DB_NM
			, SVR_SPR_USR_ID
			, SVR_SPR_SCM_PWD
			, PGHOME_PTH
			, PGDATA_PTH
			, USEYN
			, FRST_REGR_ID
			, FRST_REG_DTM
			, LST_MDFR_ID
			, LST_MDF_DTM
		) 
		VALUES
		(
			  nextval('q_dbsvr_i_01')
			, #{db_svr_nm}
			, #{ipadr}
			, #{portno}
			, #{dft_db_nm}
			, #{svr_spr_usr_id}
			, #{svr_spr_scm_pwd}
			, #{pghome_pth}
			, #{pgdata_pth}
			, 'Y'
			, #{frst_regr_id}
			, clock_timestamp()
			, #{lst_mdfr_id}
			, clock_timestamp()	
		)
	</insert>    
	
	
	   <update id="updateDbServer" parameterType="dbServerVO">
   	    /**
	 	* Query ID : updateDbServer
	 	* Description : DB서버 수정
	 	* Author : 변승우
	 	**/
	 	
		UPDATE T_DBSVR_I
		SET 
	  	 	   DB_SVR_NM= #{db_svr_nm}
		      , IPADR=#{ipadr}
		      , PORTNO=#{portno}
		      , DFT_DB_NM=#{dft_db_nm}
			  , SVR_SPR_USR_ID=#{svr_spr_usr_id}
			  , SVR_SPR_SCM_PWD=#{svr_spr_scm_pwd}
			  , PGHOME_PTH=#{pghome_pth}
			  , PGDATA_PTH=#{pgdata_pth}
			  , USEYN = #{useyn}
			  , LST_MDFR_ID=#{lst_mdfr_id}
			  , LST_MDF_DTM=clock_timestamp()	
		WHERE DB_SVR_ID=#{db_svr_id}
	</update> 
	
	
<!-- <delete id="deleteCmmnCode" parameterType="cmmnCodeVO">
       	/**
	 	* Query ID : deleteCmmnCode
	 	* Description : 공통코드 삭제
	 	* Author : 변승우
	 	**/
	 	
	  DELETE 
	  FROM T_SYSGRP_C 
	  WHERE GRP_CD=#{grp_cd}
	</delete> -->
	
	
	<delete id="deleteDB" parameterType="dbServerVO">
       	/**
	 	* Query ID : deleteDB
	 	* Description : DB삭제
	 	* Author : 변승우
	 	**/
	 	
	  DELETE 
	  FROM T_DB_I 
	  WHERE DB_SVR_ID=#{db_svr_id}
	  AND USEYN = 'Y'
	</delete>
	
	
	<insert id="insertDB" parameterType="HashMap">
    	/**
	 	*  Query ID : insertDB
	 	* Description : insertDB 등록
	 	* Author : 변승우
	 	**/
	 	
		INSERT INTO T_DB_I
		(
			  DB_ID
			, DB_SVR_ID
			, DB_NM
			, USEYN
			, DB_EXP
			, FRST_REGR_ID
			, FRST_REG_DTM
			, LST_MDFR_ID
			, LST_MDF_DTM
		) 
		VALUES
		(
			  nextval('q_db_i_01')
			, #{db_svr_id}
			, #{dft_db_nm}
			, #{useyn}
			, #{db_exp}
			, #{frst_regr_id}
			, clock_timestamp()
			, #{lst_mdfr_id}
			, clock_timestamp()	
		)
	</insert>    
	
	
	<select id="selectDbList" resultType="dbVO">
		/**
	 	*  Query ID : selectDbList
	 	* Description : DB 리스트 조회
	 	* Author : 변승우
	 	**/
	 	
          SELECT 
                  (ROW_NUMBER() OVER()) AS ROWNUM
				, (ROW_NUMBER() OVER()) AS IDX
                , DB_ID
                , DB_SVR_ID
                , DB_NM
                , DB_USR_ID
                , DB_EXP
				, FRST_REGR_ID
				, TO_CHAR(FRST_REG_DTM,'YYYY-MM-DD HH24:MI:SS') AS FRST_REG_DTM
				, LST_MDFR_ID
				, TO_CHAR(LST_MDF_DTM,'YYYY-MM-DD HH24:MI:SS') AS LST_MDF_DTM
          FROM T_DB_I
          WHERE USEYN = 'Y'
     </select>	
     
     
     <select id="selectRepoDBList" resultType="HashMap" parameterType="HashMap">
		/**
	 	*  Query ID : selectRepoDBList
	 	* Description : DB Repository 리스트 조회
	 	* Author : 변승우
	 	**/
	 	
		SELECT
              (ROW_NUMBER() OVER()) AS ROWNUM
			, (ROW_NUMBER() OVER()) AS IDX
            , AA.DB_SVR_NM
            , AA.IPADR
            , AA.PORTNO
            , AA.DB_ID
            , AA.DB_NM
            , AA.DB_EXP
			, AA.FRST_REGR_ID
			, AA.FRST_REG_DTM
			, AA.LST_MDFR_ID
			, AA.LST_MDF_DTM
        FROM(
	            SELECT
	                 A.DB_SVR_NM
	                , A.IPADR
	                , A.PORTNO
	                , B.DB_ID
	                , B.DB_NM
	                , B.DB_EXP
					, A.FRST_REGR_ID
					, TO_CHAR(A.FRST_REG_DTM,'YYYY-MM-DD HH24:MI:SS') AS FRST_REG_DTM
					, A.LST_MDFR_ID
					, TO_CHAR(A.LST_MDF_DTM,'YYYY-MM-DD HH24:MI:SS') AS LST_MDF_DTM
	            FROM T_DBSVR_I A, T_DB_I B
	            WHERE 1 = 1
	            AND A.DB_SVR_ID = B.DB_SVR_ID
			    <if test="db_svr_nm != null and db_svr_nm != ''">
			    AND A.DB_SVR_NM LIKE '%' || #{db_svr_nm} || '%'
			    </if>	     
			    <if test="ipadr != null and ipadr != ''">
			    AND A.IPADR LIKE '%' || #{ipadr} || '%'
			    </if>	      
			    <if test="dft_db_nm != null and dft_db_nm != ''">
			    AND B.DB_NM LIKE  '%' || #{dft_db_nm} || '%'
			    </if>         	            
			    AND B.USEYN = 'Y'
	            ORDER BY A.DB_SVR_NM
            	)AA
     </select>	
     

     <select id="selectSvrList" resultType="HashMap" parameterType="integer">
		/**
	 	*  Query ID : selectSvrList
	 	* Description : Repository 등록된 DB의 서버 리스트 조회
	 	* Author : 변승우
	 	**/ 	
	 	
            SELECT
            		A.DB_SVR_ID
                 	, A.DB_SVR_NM
	                , A.IPADR
	                , A.PORTNO
            FROM T_DBSVR_I A, T_DB_I B
            WHERE 1 = 1
            AND A.DB_SVR_ID = B.DB_SVR_ID
			<if test="value != null and value != 0">
			AND A.DB_SVR_ID = #{value}
			</if>
			AND A.USEYN = 'Y'
			AND B.USEYN = 'Y'
            GROUP BY A.DB_SVR_NM, A.DB_SVR_ID, A.IPADR, A.PORTNO
     </select>	
     
     
     <select id="dbServerIpCheck" resultType="int">
		/**
		* Query ID : dbServerIpCheck
		* Description : IP 중복 체크
		* Author : 변승우
		**/
		SELECT 
				 COUNT(*)
		FROM T_DBSVR_I
		WHERE IPADR = #{ipadr}	
	</select>
	
	
	<select id="selectDBcnt" resultType="int" parameterType="hashmap">
		/**
		* Query ID : selectDBcnt
		* Description : DB서버 갯수 체크
		* Author : 변승우
		**/
		SELECT 
				 COUNT(*)
		FROM T_DB_I
		WHERE DB_NM = #{dft_db_nm}
	</select>


	 <update id="updateDB" parameterType="hashmap">
   	    /**
	 	* Query ID : updateDB
	 	* Description : DB 수정
	 	* Author : 변승우
	 	**/
	 	
		UPDATE T_DB_I
		SET 
	  	 	   USEYN= #{useyn}
	  	 	  , DB_EXP=#{db_exp}
			  , LST_MDFR_ID=#{lst_mdfr_id}
			  , LST_MDF_DTM=clock_timestamp()	
		WHERE DB_SVR_ID=#{db_svr_id}::numeric
		AND DB_NM=#{dft_db_nm}
	</update> 
	
	
     <select id="db_svr_nmCheck" resultType="int">
		/**
		* Query ID : db_svr_nmCheck
		* Description : 서버명 중복 체크
		* Author : 변승우
		**/
		SELECT 
				 COUNT(*)
		FROM T_DBSVR_I
		WHERE DB_SVR_NM = #{db_svr_nm}
	</select>	
	
	
	<select id="selectIpList" resultType="HashMap">
		/**
		* Query ID : selectIpList
		* Description : 등록된 Agent IP 리스트
		* Author : 변승우
		**/
		SELECT 
				IPADR
		FROM T_AGTCNDT_I
		WHERE 1=1
		AND AGT_CNDT_CD = 'TC001101'
		AND ISTCNF_YN = 'Y'
	</select>	
</mapper>
