<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="treeTransferSql">
	
	<insert id="insertTransferTarget" parameterType="transferTargetVO">
		/**
		* Query ID : insertTransferTarget
		* Description : 전송대상 등록
		* Author : 김주영
		**/
		INSERT INTO T_TRFTRGCNG_I
		(
		  TRF_TRG_ID
		, TRF_TRG_CNN_NM
		, TRF_TRG_URL
		, CONNECTOR_CLASS
		, TASK_MAX
		, HADOOP_CONF_DIR
		, HADOOP_HOME
		, FLUSH_SIZE
		, ROTATE_INTERVAL_MS
		, CNR_ID
		, FRST_REGR_ID
		, FRST_REG_DTM
		, LST_MDFR_ID
		, LST_MDF_DTM
		)
		VALUES
		(
		  nextval('q_trftrgcng_i_01')
		, #{trf_trg_cnn_nm}
		, #{trf_trg_url}
		, #{connector_class}
		, #{task_max}
		, #{hadoop_conf_dir}
		, #{hadoop_home}
		, #{flush_size}
		, #{rotate_interval_ms}
		, #{cnr_id}
		, #{frst_regr_id}
		, clock_timestamp()
		, #{lst_mdfr_id}
		, clock_timestamp()
		)		
	</insert>
	
	<delete id="deleteTransferTarget" parameterType="int">
		/**
		* Query ID : deleteTransferTarget
		* Description : 전송대상 전체 삭제
		* Author : 김주영
		**/
		DELETE FROM T_TRFTRGCNG_I
		WHERE CNR_ID=#{cnr_id}
	</delete>
	
	<select id="selectTransferDetail" resultType="transferDetailVO">
		/**
		* Query ID : selectTransferDetail
		* Description : 전송상세설정 조회
		* Author : 김주영
		**/
		SELECT 
		  T.TRF_TRG_CNN_NM
		, T.TRF_TRG_ID
		, I.DB_NM 
		, S.DB_SVR_NM
		FROM T_TRFTRGCNG_I T
			LEFT OUTER JOIN T_TRFTRGMPP_R R
			ON T.TRF_TRG_ID= R.TRF_TRG_ID
				LEFT OUTER JOIN T_DB_I I
				ON  R.DB_ID = I.DB_ID
					LEFT OUTER JOIN T_DBSVR_I S
					ON I.DB_SVR_ID = S.DB_SVR_ID
		WHERE T.CNR_ID=#{cnr_id}
	</select>
	
	<select id="selectServerDbList" parameterType="string" resultType="dbidbserverVO">
		/**
		* Query ID : selectServerDbList
		* Description : 데이터베이스 조회
		* Author : 김주영
		**/
		SELECT S.DB_SVR_ID,S.DB_SVR_NM ,I.DB_ID,I.DB_NM
		FROM T_DBSVR_I S,T_DB_I I
		WHERE S.DB_SVR_ID=I.DB_SVR_ID
		AND S.DB_SVR_NM = #{db_svr_nm}
	</select>
	
    <select id="selectServerDb" resultType="dbidbserverVO">
		/**
	 	*  Query ID : selectServerDb
	 	* Description : DB,SERVER 조회
	 	* Author : 김주영
	 	**/ 	
		SELECT 
			  D.db_id
			, D.db_nm
			, S.db_svr_id
			, S.db_svr_nm
			, S.ipadr
			, S.portno
			, S.dft_db_nm
			, S.svr_spr_usr_id
			, S.svr_spr_scm_pwd
		FROM T_DB_I D, T_DBSVR_I S
		WHERE D.db_svr_id=S.db_svr_id
		AND D.db_id=#{db_id}	  	
    </select>	
    
    <insert id="insertTransferRelation" parameterType="transferRelationVO">
		/**
	 	*  Query ID : insertTransferRelation
	 	* Description : 전송대상매핑관계 등록
	 	* Author : 김주영
	 	**/ 
		INSERT INTO T_TRFTRGMPP_R
		(
		  TRF_TRG_MPP_ID
		, TRF_TRG_ID
		, DB_ID
		, CNR_ID
		, FRST_REGR_ID
		, FRST_REG_DTM
		, LST_MDFR_ID
		, LST_MDF_DTM
		)
		VALUES
		(
		  nextval('q_trftrgmpp_r_01')
		, #{trf_trg_id}
		, #{db_id}
		, #{cnr_id}
		, #{frst_regr_id}
		, clock_timestamp()
		, #{lst_mdfr_id}
		, clock_timestamp()
		)		
    </insert>
    
    <insert id="insertTransferMapping" parameterType="transferMappingVO">
		/**
	 	*  Query ID : insertTransferMapping
	 	* Description : 전송매핑테이블내역 등록
	 	* Author : 김주영
	 	**/
	 	<selectKey resultType="int" keyProperty="trf_trg_mpp_id" order="BEFORE">
        	SELECT setval('q_trftrgmpp_r_01',nextval('q_trftrgmpp_r_01')-1);    
   	 	</selectKey>   
		INSERT INTO T_TRFMPPTB_L
		(
		  TRF_TB_ID
		, TRF_TRG_MPP_ID
		, SCM_NM
		, TB_ENGL_NM
		, FRST_REGR_ID
		, FRST_REG_DTM
		, LST_MDFR_ID
		, LST_MDF_DTM
		)
		VALUES
		(
		  nextval('q_trfmpptb_l_01')
		, #{trf_trg_mpp_id}
		, #{scm_nm}
		, #{tb_engl_nm}
		, #{frst_regr_id}
		, clock_timestamp()
		, #{lst_mdfr_id}
		, clock_timestamp()
		)		
    </insert>    
    
    <select id="selectTransferMapping" parameterType="int" resultType="transferDetailMappingVO">
    	/**
	 	*  Query ID : selectTransferMapping
	 	* Description : 전송매핑테이블내역 조회
	 	* Author : 김주영
	 	**/
		SELECT 
		  I.TRF_TRG_ID
		, R.TRF_TRG_MPP_ID
		, L.TRF_TB_ID
		, I.TRF_TRG_CNN_NM
		, L.SCM_NM
		, L.TB_ENGL_NM
		, D.DB_ID
		, D.DB_NM
		, S.DB_SVR_NM
		FROM T_TRFTRGCNG_I I,T_TRFTRGMPP_R R,T_TRFMPPTB_L L,T_DB_I D,T_DBSVR_I S
		WHERE I.TRF_TRG_ID=R.TRF_TRG_ID
		AND R.TRF_TRG_MPP_ID=L.TRF_TRG_MPP_ID
		AND R.DB_ID =D.DB_ID
		AND D.DB_SVR_ID =S.DB_SVR_ID
		AND I.TRF_TRG_ID =#{trf_trg_id}
    </select>
    
    <delete id="deleteTransferRelation" parameterType="int">
        /**
	 	*  Query ID : deleteTransferRelation
	 	* Description : 전송대상매핑관계 삭제
	 	* Author : 김주영
	 	**/   
	    DELETE FROM T_TRFTRGMPP_R
	    WHERE TRF_TRG_ID =#{trf_trg_id}
    </delete>
    
    <delete id="deleteTransferMapping" parameterType="int">
        /**
	 	*  Query ID : deleteTransferMapping
	 	* Description : 전송매핑테이블내역 삭제
	 	* Author : 김주영
	 	**/   
	    DELETE FROM T_TRFMPPTB_L
	    WHERE TRF_TRG_MPP_ID =#{trf_trg_mpp_id}
    </delete>
</mapper>
