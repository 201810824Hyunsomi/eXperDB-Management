<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="proxyMonitoringSql">

	<select id="selectProxyServerList" resultType="hashMap">
		/**
		* Query ID : selectProxyServerList
		* Description : proxy server list
		* Author : 윤정
		**/
		SELECT 
       		(ROW_NUMBER() OVER()) AS ROWNUM, 
       		(ROW_NUMBER() OVER()) AS IDX,
       		s.PRY_SVR_ID,
       		s.IPADR,
       		s.AGT_SN,
       		s.PRY_SVR_NM,
       		s.PRY_PTH,
       		s.KAL_PTH,
       		s.USE_YN,
       		s.EXE_STATUS,
       		s.MASTER_GBN,
       		s.MASTER_SVR_ID,
       		s.DB_SVR_ID,
       		s.DAY_DATA_DEL_TERM,
       		s.MIN_DATA_DEL_TERM,
       		s.FRST_REGR_ID,
       		s.FRST_REG_DTM,
       		s.LST_MDFR_ID,
       		s.LST_MDF_DTM,
       		a.AGT_CNDT_CD 
		FROM T_PRY_SVR_I s join T_PRY_AGT_I a on s.AGT_SN = a.AGT_SN
		WHERE s.USE_YN = 'Y'
        GROUP by s.PRY_SVR_ID, s.IPADR, s.MASTER_GBN, s.MASTER_SVR_ID, a.AGT_CNDT_CD
		ORDER BY coalesce(MASTER_SVR_ID, PRY_SVR_ID), MASTER_GBN DESC, LST_MDF_DTM
	</select>
	
	<select id="selectProxyServerByMasterId" resultType="hashMap">
		/**
		* Query ID : selectProxyServerByMasterId
		* Description : proxy server cluster 1set 
		* Author : 윤정
		**/
			SELECT 
       		(ROW_NUMBER() OVER()) AS ROWNUM, 
       		(ROW_NUMBER() OVER()) AS IDX,
       		s.PRY_SVR_ID,
       		s.IPADR,
       		s.AGT_SN,
       		s.PRY_SVR_NM,
       		s.PRY_PTH,
       		s.KAL_PTH,
       		s.USE_YN,
       		s.EXE_STATUS,
       		s.KAL_EXE_STATUS,
       		s.MASTER_GBN,
       		s.MASTER_SVR_ID,
       		s.DB_SVR_ID,
       		s.DAY_DATA_DEL_TERM,
       		s.MIN_DATA_DEL_TERM,
       		s.FRST_REGR_ID,
       		s.FRST_REG_DTM,
       		s.LST_MDFR_ID,
       		s.LST_MDF_DTM,
       		a.AGT_CNDT_CD,
       		v.V_IP 
		FROM T_PRY_SVR_I s 
		JOIN T_PRY_AGT_I a ON s.AGT_SN = a.AGT_SN 
		JOIN T_PRY_VIPCNG_I v ON s.PRY_SVR_ID = v.PRY_SVR_ID
		<if test="value != null and value != '' ">
        WHERE (s.PRY_SVR_ID = #{value} 
        OR s.MASTER_SVR_ID = #{value})
        </if>
        AND v.STATE_NM = 'MASTER'
		ORDER BY coalesce(s.MASTER_SVR_ID, s.PRY_SVR_ID), s.MASTER_GBN DESC, LST_MDF_DTM
	</select>
	
	<select id="selectDBServerConProxy" resultType="hashMap" parameterType="int">
		/**
		* Query ID : selectDBServerConProxy
		* Description : db server connected proxy
		* Author : 윤정
		**/
		SELECT        		
       		(ROW_NUMBER() OVER()) AS ROWNUM, 
       		(ROW_NUMBER() OVER()) AS IDX,
		--	tpsi.PRY_SVR_ID , 
			tdi.MASTER_GBN , 
			tdi.DB_SVR_ID,
			tdi.IPADR , 
			tdi.PORTNO , 
			tdi.SVR_HOST_NM , 
			tai.AGT_CNDT_CD 
		FROM T_PRY_SVR_I tpsi 
		JOIN T_DBSVRIPADR_I tdi  ON tpsi.DB_SVR_ID = tdi.DB_SVR_ID
		JOIN T_AGTCNDT_I tai ON tdi.IPADR = tai.IPADR
		WHERE tpsi.PRY_SVR_ID = #{pry_svr_id}::numeric OR tpsi.MASTER_SVR_ID = #{pry_svr_id}::numeric
		GROUP BY tdi.MASTER_GBN, tdi.DB_SVR_ID, tdi.IPADR , tdi.PORTNO , tdi.SVR_HOST_NM ,  tai.AGT_CNDT_CD 
		ORDER BY tdi.MASTER_GBN, tdi.DB_SVR_ID
	</select>
	
	<select id="selectProxyLogList" resultType="hashMap" parameterType="int">
		/**
		* Query ID : selectProxyLogList
		* Description : proxy starting state list
		* Author : 윤정
		**/
		SELECT
			(ROW_NUMBER() OVER()) AS ROWNUM, 
			(ROW_NUMBER() OVER()) AS IDX,
			tpsi.PRY_SVR_ID, 
			tpsi.PRY_SVR_NM , 
			tpacg.PRY_ACT_EXE_SN, 
			tpacg.SYS_TYPE, 
			tpacg.ACT_TYPE,
			tpacg.ACT_EXE_TYPE, 
			tpacg.EXE_RSLT_CD,
			TO_CHAR(tpacg.WRK_DTM,'YYYY-MM-DD HH24:MI:SS') AS WRK_DTM
		FROM T_PRY_SVR_I tpsi 
		JOIN T_PRY_ACTSTATE_CNG_G tpacg on tpsi.PRY_SVR_ID = tpacg.PRY_SVR_ID 
		WHERE (tpsi.PRY_SVR_ID = #{pry_svr_id}::numeric
		OR tpsi.MASTER_SVR_ID = #{pry_svr_id}::numeric)
		ORDER BY tpacg.WRK_DTM DESC
		LIMIT 5
	</select>
	
	<select id="selectConfiguration" resultType="hashMap" parameterType="hashMap">
		/**
		* Query ID : selectConfiguration
		* Description : proxy, keepalived config file
		* Author : 윤정
		**/
		SELECT 
			(ROW_NUMBER() OVER()) AS ROWNUM, 
			(ROW_NUMBER() OVER()) AS IDX,
			tpsi.PRY_SVR_ID,
			tpsi.IPADR,
		<if test='type == "P"'>
			tpsi.PRY_PTH AS PATH,
        </if>
        <if test='type == "K"'>
			tpsi.KAL_PTH AS PATH,
        </if>
        	tpsi.PRY_SVR_NM,
        	tpai.SOCKET_PORT
		FROM T_PRY_SVR_I tpsi
		JOIN T_PRY_AGT_I tpai ON tpsi.AGT_SN = tpai.AGT_SN
		WHERE tpsi.PRY_SVR_ID = #{pry_svr_id}::numeric
	</select>
	
	<select id="selectProxyStatisticsInfo" parameterType="int" resultType="hashMap">
		/**
		* Query ID : selectProxyStatisticsInfo
		* Description : proxy listener statistics information
		* Author : 윤정
		**/
		<![CDATA[
			SELECT *
			FROM (
				SELECT
					ROW_NUMBER() OVER (PARTITION BY tpsi.PRY_SVR_ID, tpssg.LSN_ID, tpssg.DB_CON_ADDR ORDER BY exe_dtm desc) AS r, 
					(ROW_NUMBER() OVER()) AS ROWNUM, 
					(ROW_NUMBER() OVER()) AS IDX,
					tpsi.PRY_SVR_ID,
					tpsi.MASTER_GBN, 
					tpssg.EXE_DTM, 
					to_char(tpssg.EXE_DTM, 'HH24:MI') as EXE_DTM_SS,
					tpsi.PRY_SVR_NM,
					tpli.LSN_NM, 
					tpssg.DB_CON_ADDR, 
					tpssg.SVR_STATUS, 
					tpssg.LST_STATUS_CHK_DESC, 
					tpssg.FAIL_CHK_CNT, 
					tpssg.MAX_SESSION, 
					tpssg.CUR_SESSION,
					tpssg.SESSION_LIMIT, 
					tpssg.CUMT_SSO_CON_CNT, 
					tpssg.BYTE_RECEIVE, 
					tpssg.BYTE_TRANSMIT,
					tpssg.SVR_STOP_TM,
					tpssg.lsn_svr_id
				FROM T_PRY_SVR_I tpsi 
				JOIN T_PRY_LSN_I tpli ON tpsi.PRY_SVR_ID = tpli.PRY_SVR_ID 
				JOIN T_PRY_SVR_STATUS_G tpssg ON tpsi.PRY_SVR_ID = tpssg.PRY_SVR_ID AND tpli.LSN_ID = tpssg.LSN_ID
				WHERE tpsi.PRY_SVR_ID = #{value}
				OR tpsi.MASTER_SVR_ID = #{value}
				ORDER BY  tpsi.master_gbn desc, tpsi.pry_svr_id, tpli.lsn_id, tpssg.lsn_svr_id, tpssg.EXE_DTM DESC
			) x
			WHERE x.r <= 2
		]]>
	</select>
	
	<select id="selectProxyStatisticsChartInfo2" parameterType="int" resultType="hashMap">
		/**
		* Query ID : selectProxyStatisticsChartInfo
		* Description : proxy listener statistics information
		* Author : 윤정
		**/
		<![CDATA[
			SELECT 
				(ROW_NUMBER() OVER(PARTITION BY x.PRY_SVR_ID, x.LSN_ID, x.lsn_svr_id, x.DB_CON_ADDR ORDER BY exe_dtm)) AS ROWNUM, 
				(ROW_NUMBER() OVER(PARTITION BY x.PRY_SVR_ID, x.LSN_ID, x.lsn_svr_id ,x.DB_CON_ADDR ORDER BY exe_dtm)) AS IDX,
				DENSE_RANK() OVER( ORDER BY x.PRY_SVR_ID, x.LSN_ID, x.DB_CON_ADDR DESC) AS DENSE_ROW_NUM,
				*
			FROM (
				SELECT
					ROW_NUMBER() OVER (PARTITION BY tpsi.PRY_SVR_ID, tpssg.LSN_ID, tpssg.lsn_svr_id, tpssg.DB_CON_ADDR ORDER BY exe_dtm desc) AS r, 
					tpsi.PRY_SVR_ID, 
					tpssg.LSN_ID,
					tpssg.EXE_DTM, 
					to_char(tpssg.EXE_DTM, 'YYYY-MM-DD HH24:MI') as EXE_DTM_SS,
					tpsi.PRY_SVR_NM,
					tpli.LSN_NM, 
					tpssg.DB_CON_ADDR, 
					tpssg.SVR_STATUS, 
					tpssg.LST_STATUS_CHK_DESC, 
					tpssg.FAIL_CHK_CNT, 
					tpssg.MAX_SESSION, 
					tpssg.CUR_SESSION,
					tpssg.SESSION_LIMIT, 
					tpssg.CUMT_SSO_CON_CNT, 
					tpssg.BYTE_RECEIVE, 
					tpssg.BYTE_TRANSMIT,
					tpssg.SVR_STOP_TM,
					tpssg.lsn_svr_id
				FROM T_PRY_SVR_I tpsi 
				JOIN T_PRY_LSN_I tpli ON tpsi.PRY_SVR_ID = tpli.PRY_SVR_ID 
				JOIN T_PRY_LSN_SVR_I tpsli ON tpsi.PRY_SVR_ID = tpsli.PRY_SVR_ID AND tpli.LSN_ID = tpsli.LSN_ID
				JOIN T_PRY_SVR_STATUS_G tpssg ON tpssg.lsn_svr_id = tpsli.lsn_svr_id
				WHERE tpsi.PRY_SVR_ID = #{pry_svr_id}::numeric
				ORDER BY tpsi.pry_svr_id, tpli.lsn_id, tpssg.lsn_svr_id, tpssg.DB_CON_ADDR, tpssg.EXE_DTM desc
			) x
			WHERE x.r <= 5
			ORDER BY x.pry_svr_id, x.lsn_id, x.lsn_svr_id, x.DB_CON_ADDR, x.EXE_DTM
		]]>
	</select>

	<select id="selectProxyStatisticsChartInfo" parameterType="int" resultType="hashMap">
		/**
		* Query ID : selectProxyStatisticsChartInfo
		* Description : proxy listener statistics information
		* Author : 윤정
		**/
		<![CDATA[
			SELECT 
				(ROW_NUMBER() OVER(PARTITION BY x.PRY_SVR_ID, x.LSN_ID, x.lsn_svr_id, x.DB_CON_ADDR ORDER BY exe_dtm)) AS ROWNUM, 
				(ROW_NUMBER() OVER(PARTITION BY x.PRY_SVR_ID, x.LSN_ID, x.lsn_svr_id ,x.DB_CON_ADDR ORDER BY exe_dtm)) AS IDX,
				DENSE_RANK() OVER( ORDER BY x.PRY_SVR_ID, x.LSN_ID, x.DB_CON_ADDR DESC) AS DENSE_ROW_NUM,
				*
			FROM (
				SELECT
					ROW_NUMBER() OVER (PARTITION BY tpsi.PRY_SVR_ID, tpssg.LSN_ID, tpssg.lsn_svr_id, tpssg.DB_CON_ADDR ORDER BY exe_dtm desc) AS r, 
					tpsi.PRY_SVR_ID, 
					tpssg.LSN_ID,
					tpssg.EXE_DTM, 
					to_char(tpssg.EXE_DTM, 'YYYY-MM-DD HH24:MI') as EXE_DTM_SS,
					tpsi.PRY_SVR_NM,
					tpli.LSN_NM, 
					tpssg.DB_CON_ADDR, 
					tpssg.SVR_STATUS, 
					tpssg.LST_STATUS_CHK_DESC, 
					tpssg.FAIL_CHK_CNT, 
					tpssg.MAX_SESSION, 
					tpssg.CUR_SESSION,
					tpssg.SESSION_LIMIT, 
					tpssg.CUMT_SSO_CON_CNT, 
					tpssg.BYTE_RECEIVE, 
					tpssg.BYTE_TRANSMIT,
					tpssg.SVR_STOP_TM,
					tpssg.lsn_svr_id
				FROM T_PRY_SVR_I tpsi 
				JOIN T_PRY_LSN_I tpli ON tpsi.PRY_SVR_ID = tpli.PRY_SVR_ID 
				JOIN T_PRY_LSN_SVR_I tpsli ON tpsi.PRY_SVR_ID = tpsli.PRY_SVR_ID AND tpli.LSN_ID = tpsli.LSN_ID
				JOIN T_PRY_SVR_STATUS_G tpssg ON tpsi.PRY_SVR_ID = tpssg.PRY_SVR_ID AND tpli.LSN_ID = tpssg.LSN_ID AND tpssg.lsn_svr_id = tpsli.lsn_svr_id
				WHERE tpsi.PRY_SVR_ID = #{pry_svr_id}::numeric
				ORDER BY tpsi.pry_svr_id, tpli.lsn_id, tpssg.lsn_svr_id, tpssg.DB_CON_ADDR, tpssg.EXE_DTM desc
			) x
			WHERE x.r <= 5
			ORDER BY x.pry_svr_id, x.lsn_id, x.lsn_svr_id, x.DB_CON_ADDR, x.EXE_DTM
		]]>
	</select>

	<select id="selectProxyChartCntList" parameterType="int" resultType="hashMap">
		/**
		* Query ID : selectProxyChartCntList
		* Description : proxy listener statistics information
		* Author : 윤정
		**/
		<![CDATA[
			SELECT
					x.PRY_SVR_ID,
					x.PRY_SVR_NM,
					x.DB_CON_ADDR,
					x.LSN_NM
			FROM (
				SELECT
					ROW_NUMBER() OVER (PARTITION BY tpsi.PRY_SVR_ID, tpssg.LSN_ID, tpssg.lsn_svr_id, tpssg.DB_CON_ADDR ORDER BY exe_dtm) AS r, 
					tpsi.PRY_SVR_ID,
					tpsi.PRY_SVR_NM,
					tpli.LSN_NM,
					tpssg.DB_CON_ADDR,
					tpssg.lsn_svr_id,
					tpssg.LSN_ID,
					tpssg.exe_dtm
				FROM T_PRY_SVR_I tpsi 
				JOIN T_PRY_LSN_I tpli ON tpsi.PRY_SVR_ID = tpli.PRY_SVR_ID 
				JOIN T_PRY_LSN_SVR_I tpsli ON tpsi.PRY_SVR_ID = tpsli.PRY_SVR_ID AND tpli.LSN_ID = tpsli.LSN_ID
				JOIN T_PRY_SVR_STATUS_G tpssg ON tpsi.PRY_SVR_ID = tpssg.PRY_SVR_ID AND tpli.LSN_ID = tpssg.LSN_ID AND tpssg.lsn_svr_id = tpsli.lsn_svr_id
				WHERE (tpsi.PRY_SVR_ID = #{value} OR tpsi.MASTER_SVR_ID = #{value})
				  AND tpsi.MASTER_GBN = 'M'
				ORDER BY tpsi.pry_svr_id, tpli.lsn_id, tpssg.lsn_svr_id, tpssg.DB_CON_ADDR, tpssg.EXE_DTM
			) x
			where r = 1
			ORDER BY x.pry_svr_id, x.lsn_id, x.lsn_svr_id, x.DB_CON_ADDR, x.EXE_DTM
		]]>
	</select>
	
	<select id="selectActExeFailLog" parameterType="int" resultType="hashMap">
		/**
		* Query ID : selectExeFailMsg
		* Description : proxy / keepalived 기동-정지 실패 시 log 보여주기 
		* Author : 윤정
		**/
		SELECT 
			tpsi.PRY_SVR_ID , 
			tpsi.PRY_SVR_NM , 
			tpacg.PRY_ACT_EXE_SN, 
			tpacg.SYS_TYPE , 
			tpacg.ACT_TYPE , 
			tpacg.ACT_EXE_TYPE , 
			tpacg.RSLT_MSG
		FROM T_PRY_SVR_I tpsi
		JOIN T_PRY_ACTSTATE_CNG_G tpacg
		ON tpsi.PRY_SVR_ID = tpacg.PRY_SVR_ID
		WHERE tpacg.PRY_ACT_EXE_SN = #{PRY_ACT_EXE_SN}::numeric
	</select>
	
	<insert id="insertActExeCng" parameterType="hashMap">
		/**
		* Query ID : insertActExeCng
		* Description : proxy / keepalived 기동-정지 상태 변경 
		* Author : 윤정
		**/
		WITH ins1 AS (
			INSERT INTO T_PRY_ACTSTATE_CNG_G (
				pry_act_exe_sn, 
				pry_svr_id, 
				sys_type, 
				act_type, 
				act_exe_type, 
				wrk_dtm,
				exe_rslt_cd, 
				rslt_msg, 
				frst_regr_id, 
				frst_reg_dtm, 
				lst_mdfr_id, 
				lst_mdf_dtm
			)
			VALUES (
				NEXTVAL('q_t_pry_actstate_cng_g_01'),
				#{pry_svr_id}::numeric, 
				#{sys_type},
				#{act_type},
				#{act_exe_type}, 
				clock_timestamp(), 
				#{exe_rslt_cd},
				'', 
				#{frst_regr_id}, 
				clock_timestamp(), 
				#{lst_mdfr_id}, 
				clock_timestamp()
			)
		)
		UPDATE T_PRY_SVR_I 
		<if test='sys_type == "PROXY"'>
			SET EXE_STATUS = #{status}
		</if>
		<if test='sys_type == "KEEPALIVED"'>
			SET KAL_EXE_STATUS = #{status}
		</if>
		WHERE PRY_SVR_ID = #{pry_svr_id}::numeric
	</insert>

	<select id="selectAgentCount" resultType="int">
   		/**
	 	* Query ID : selectAgentCount -에이전트 화면
	 	* Description : proxy agent count
	 	* Author :
	 	**/
		SELECT 
       			COUNT(AGT_SN) AS CNT
		  FROM 	T_PRY_AGT_I
		WHERE   ISTCNF_YN = 'Y'
    </select>

	<select id="selectProxyAgentList" parameterType="proxyAgentVO"  resultType="proxyAgentVO">
			/**
			* Query ID : selectProxyAgentList
			* Description : proxy agent 조회
			* Author : 
			**/
	        SELECT 
	               (ROW_NUMBER() OVER(ORDER BY A.AGT_SN, A.LST_MDF_DTM DESC)) AS ROWNUM
	             , A.AGT_SN
	             , A.IPADR
	             , A.DOMAIN_NM
	             , A.SOCKET_PORT
	             , A.AGT_CNDT_CD
	             , TO_CHAR(A.STRT_DTM,'YYYY-MM-DD HH24:MI:SS') AS STRT_DTM
	             , A.SVR_USE_YN
	             , A.AGT_VERSION
	             , B.PRY_SVR_NM
	             , B.MASTER_GBN
	          FROM T_PRY_AGT_I A
	               LEFT JOIN T_PRY_SVR_I B ON A.AGT_SN = B.AGT_SN AND A.IPADR = B.IPADR
	         WHERE 1 = 1
	
	          <if test="sch_domain_nm != null and sch_domain_nm != '' ">
	           AND A.DOMAIN_NM LIKE '%' || #{sch_domain_nm} || '%'
	          </if>
	               
	          <if test="sch_ipadr != null and sch_ipadr != '' ">
	           AND A.IPADR = #{sch_ipadr}
	          </if>
	               
	          <if test="sch_svr_use_yn != null and sch_svr_use_yn != '' ">
	           AND A.SVR_USE_YN = #{sch_svr_use_yn}
	          </if>
	
	         ORDER BY A.AGT_SN, A.LST_MDF_DTM DESC
	</select>
</mapper>