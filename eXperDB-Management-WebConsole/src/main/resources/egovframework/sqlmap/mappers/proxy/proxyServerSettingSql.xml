<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="proxyServerSettingSql">

	<select id="selectProxyServerList" resultType="proxyServerVO">
		/**
		* Query ID : selectProxyServerList
		* Description : proxy server list
		* Author : 김민정
		**/
		SELECT 
       			(ROW_NUMBER() OVER()) AS ROWNUM, 
       			(ROW_NUMBER() OVER()) AS IDX,
       			A.PRY_SVR_ID,
       			A.IPADR,
       			A.AGT_SN,
       			A.PRY_SVR_NM,
       			A.PRY_PTH,
       			A.KAL_PTH,
       			A.USE_YN,
       			A.EXE_STATUS,
       			A.KAL_EXE_STATUS,
       			A.MASTER_GBN,
       			A.MASTER_SVR_ID,
       			A.DB_SVR_ID,
       			A.DAY_DATA_DEL_TERM,
       			A.MIN_DATA_DEL_TERM,
       			A.FRST_REGR_ID,
       			A.FRST_REG_DTM,
       			A.LST_MDFR_ID,
       			A.LST_MDF_DTM
		FROM 	T_PRY_SVR_I A INNER JOIN T_PRY_AGT_I B ON A.AGT_SN = B.AGT_SN
		WHERE   1 = 1
			<if test="svr_use_yn != null and svr_use_yn != '' ">
				AND B.SVR_USE_YN = #{svr_use_yn}
			</if>
			<if test="search != null and search != '' ">
	        	AND (A.IPADR LIKE #{search}  OR	 A.PRY_SVR_NM LIKE #{search} )
	        </if>
	        <if test="pry_svr_nm != null and pry_svr_nm != '' ">
	        	AND A.PRY_SVR_NM = #{pry_svr_nm}
	        	<if test="not_pry_svr_id != null and not_pry_svr_id != '' ">
	        		AND A.PRY_SVR_ID != #{not_pry_svr_id}
	        	</if>
	        </if>
        ORDER BY A.LST_MDF_DTM DESC
	</select>
	<select id="selectProxyGlobal" resultType="proxyGlobalVO">
        /**
		* Query ID : selectProxyGlobal
		* Description : proxy global info 
		* Author : 김민정
		**/
		SELECT 	PRY_GLB_ID,
				PRY_SVR_ID, 
				MAX_CON_CNT, 
				CL_CON_MAX_TM, 
				CON_DEL_TM, 
				SVR_CON_MAX_TM, 
				CHK_TM, IF_NM, 
				OBJ_IP, 
				PEER_SERVER_IP, 
				FRST_REGR_ID, 
				FRST_REG_DTM, 
				LST_MDFR_ID, 
				LST_MDF_DTM 
		FROM 	T_PRY_GLB_I
		WHERE 	PRY_SVR_ID =#{pry_svr_id}
	</select>
	<select id="selectProxyListenerList" resultType="proxyListenerVO">
        /**
		* Query ID : selectProxyListenerList
		* Description : proxy Listener info List
		* Author : 김민정
		**/
		SELECT 	LSN_ID, 
				PRY_SVR_ID, 
				LSN_NM, 
				CON_BIND_PORT, 
				LSN_DESC, 
				DB_USR_ID, 
				DB_ID, 
				DB_NM, 
				CON_SIM_QUERY, 
				FIELD_VAL, 
				FIELD_NM, 
				FRST_REGR_ID, 
				FRST_REG_DTM, 
				LST_MDFR_ID, 
				LST_MDF_DTM 
		FROM 	T_PRY_LSN_I
		WHERE 	PRY_SVR_ID =#{pry_svr_id}
	</select>
	<select id="selectProxyVipConfList" resultType="proxyVipConfigVO">
        /**
		* Query ID : selectProxyVipConfList
		* Description : proxy Vip Config info List
		* Author : 김민정
		**/
		SELECT 	VIP_CNG_ID, 
				STATE_NM, 
				PRY_SVR_ID, 
				V_IP, 
				V_ROT_ID, 
				V_IF_NM, 
				PRIORITY, 
				CHK_TM, 
				FRST_REGR_ID, 
				FRST_REG_DTM, 
				LST_MDFR_ID, 
				LST_MDF_DTM 
		FROM 	T_PRY_VIPCNG_I
		WHERE 	PRY_SVR_ID =#{pry_svr_id}
	</select> 
	<select id="selectDbmsList" resultType="hashMap">
	 	/**
		* Query ID : selectDbmsList
		* Description : 연결 DBMS 목록 가져오기
		* Author : 김민정
		**/
    	SELECT 	db_svr_id,
       			db_svr_nm
		FROM 	T_DBSVR_I 
		ORDER 	BY db_svr_nm
	</select>
	<select id="selectMasterProxyList" resultType="hashMap">
	 	/**
		* Query ID : selectMasterProxyList
		* Description : Master Proxy select 항목 가져오기
		* Author : 김민정
		**/
    	SELECT 	pry_svr_id,
       			pry_svr_nm
		FROM 	T_PRY_SVR_I
		WHERE 	DB_SVR_ID = (SELECT DB_SVR_ID FROM T_PRY_SVR_I WHERE PRY_SVR_ID = #{pry_svr_id})
		AND 	PRY_SVR_ID != #{pry_svr_id}
		ORDER 	BY pry_svr_nm
	</select>
	<update id="updateProxyAgentInfo" parameterType="proxyServerVO">
        /**
        * Query ID : updateProxyAgentInfo
        * Description : Proxy Agent 정보 업데이트
        * Author : 김민정
        **/
        UPDATE T_PRY_AGT_I
           SET SVR_USE_YN = #{svr_use_yn}
             , LST_MDFR_ID = #{lst_mdfr_id}
             , LST_MDF_DTM = clock_timestamp()
         WHERE AGT_SN = #{agt_sn}::numeric
	</update>
	<update id="updateProxyServerInfo" parameterType="proxyServerVO">
        /**
        * Query ID : updateProxyServerInfo"
        * Description : Proxy 서버 정보 업데이트
        * Author : 김민정
        **/
        UPDATE T_PRY_SVR_I
           SET PRY_SVR_NM = #{pry_svr_nm}
             , DAY_DATA_DEL_TERM = #{day_data_del_term}::numeric
             , MIN_DATA_DEL_TERM = #{min_data_del_term}::numeric
             , DB_SVR_ID = #{db_svr_id}::numeric
             , MASTER_GBN = #{master_gbn}
             , USE_YN = #{use_yn}
             , LST_MDFR_ID = #{lst_mdfr_id}
             , LST_MDF_DTM = clock_timestamp()
         WHERE PRY_SVR_ID = #{pry_svr_id}::numeric
	</update>
</mapper>
