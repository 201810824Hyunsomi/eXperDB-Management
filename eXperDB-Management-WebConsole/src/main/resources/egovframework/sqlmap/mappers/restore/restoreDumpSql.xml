<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="restoreDumpSql">

	    <select id="selectBckInfo" parameterType="workLogVO" resultType="workLogVO">
			 	SELECT
			 		(ROW_NUMBER() OVER()) AS ROWNUM,
			 		AA.DB_SVR_ID,
		            AA.IPADR,
			 		AA.EXE_SN,
			 		AA.SCD_ID,
			 		AA.SCD_NM,
			 		AA.WRK_ID,
			 		AA.WRK_NM,
			 		AA.WRK_EXP,
			 		AA.WRK_STRT_DTM,
			 		AA.WRK_END_DTM,
			 		AA.WRK_DTM,
			 		AA.EXE_RSLT_CD,
			 		AA.EXE_RSLT_CD_NM,
			 		AA.BCK_OPT_CD,
			 		AA.BCK_OPT_CD_NM,
			 		AA.TLI,
			 		AA.FILE_SZ,
			 		AA.DB_ID,
			 		AA.DB_NM,
			 		AA.BCK_FILE_PTH,
			 		AA.BCK_FILENM,
			 		AA.FRST_REGR_ID,
			 		AA.RSLT_MSG,
			 		AA.FIX_RSLTCD,
			 		AA.FIX_RSLT_MSG,
			 		AA.FRST_REG_DTM,
			 		AA.LST_MDFR_ID,
			 		AA.LST_MDF_DTM,
			 		AA.FILE_FMT_CD_NM,
			 		AA.FILE_FMT_CD,
			 		AA.USR_ROLE_NM
		        FROM
		        (SELECT
		        	B.DB_SVR_ID,
			 		B.IPADR,
			 		TWG.EXE_SN AS EXE_SN,
			 		TWG.SCD_ID AS SCD_ID,
			 		(SELECT SCD_NM FROM T_SCD_M WHERE TWG.SCD_ID = SCD_ID ) AS SCD_NM,
			 		TWG.WRK_ID AS WRK_ID,
			 		(SELECT WRK_NM FROM T_WRKCNG_I WHERE WRK_ID = TWI.WRK_ID) WRK_NM,
			 		(SELECT WRK_EXP FROM T_WRKCNG_I WHERE WRK_ID = TWI.WRK_ID) WRK_EXP,
			 		to_char(TWG.WRK_STRT_DTM,'YYYY-MM-DD HH24:MI') AS WRK_STRT_DTM,
			 		to_char(TWG.WRK_END_DTM,'YYYY-MM-DD HH24:MI') AS WRK_END_DTM,
			 		to_char(to_char(TWG.WRK_END_DTM,'YYYY-MM-DD HH24:MI')::timestamp - to_char(TWG.WRK_STRT_DTM,'YYYY-MM-DD HH24:MI')::timestamp, 'HH24:MI') AS WRK_DTM,
			 		TWG.EXE_RSLT_CD AS EXE_RSLT_CD,
			 		(SELECT SYS_CD_NM FROM T_SYSDTL_C WHERE TWG.EXE_RSLT_CD = SYS_CD ) AS EXE_RSLT_CD_NM,
			 		TWG.BCK_OPT_CD AS BCK_OPT_CD,
			 		(SELECT SYS_CD_NM FROM T_SYSDTL_C WHERE TWG.BCK_OPT_CD = SYS_CD ) AS BCK_OPT_CD_NM,
			 		TWG.TLI AS TLI,
			 		TWG.FILE_SZ AS FILE_SZ,
			 		TWG.DB_ID AS DB_ID,
			 		(SELECT DB_NM FROM T_DB_I WHERE TWG.DB_ID=DB_ID AND USEYN = 'Y') AS DB_NM,
			 		TWG.BCK_FILE_PTH AS BCK_FILE_PTH,
			 		TWG.BCK_FILENM AS BCK_FILENM,
			 		TWG.FRST_REGR_ID AS FRST_REGR_ID,
			 		TWG.RSLT_MSG AS RSLT_MSG,
			 		TWG.FIX_RSLTCD,
			 		TWG.FIX_RSLT_MSG,
			 		to_char(TWG.FRST_REG_DTM,'YYYY-MM-DD HH24:MI') AS FRST_REG_DTM,
			 		TWG.LST_MDFR_ID AS LST_MDFR_ID,
			 		to_char(TWG.LST_MDF_DTM,'YYYY-MM-DD HH24:MI') AS LST_MDF_DTM,
			 		(SELECT SYS_CD_NM FROM T_SYSDTL_C WHERE TWI.FILE_FMT_CD = SYS_CD ) AS FILE_FMT_CD_NM,
			 		TWI.FILE_FMT_CD,
			 		TWI.USR_ROLE_NM	 		
			 	FROM T_WRKEXE_G TWG, T_BCK_WRKCNG_I TWI, T_DBSVRIPADR_I B, T_WRKCNG_I C
		 	 	WHERE 1=1
			 		AND TWG.WRK_ID = TWI.WRK_ID
			 		AND TWG.WRK_ID = C.WRK_ID 
		            AND B.DB_SVR_ID=#{db_svr_id}::numeric 
		            AND TWG.DB_SVR_IPADR_ID = B.DB_SVR_IPADR_ID 	
			      	AND TWG.EXE_SN=#{exe_sn}
		      		ORDER BY LST_MDF_DTM DESC
		      	)AA	    
	    </select>
	    
	    
		<insert id="insertDumpRestore" parameterType="restoreDumpVO">
			/**
		 	* Query ID : "insertDumpRestore"
		 	* Description : DUMP RESOTRE 등록
		 	* Author : 변승우
		 	**/
		 	INSERT INTO T_DUMP_RESTORE
		 		(
		 		RESTORE_SN
		 		, DB_SVR_ID
		 		, RESTORE_NM
		 		, RESTORE_EXP
		 		, WRK_ID
		 		, WRKEXE_SN
		 		, RESTORE_CNDT
		 		, FORMAT	 		
		 		, FILENAME
		 		, JOBS
		 		, ROLE
		 		, PRE_DATA_YN
		 		, DATA_YN
		 		, POST_DATA_YN
		 		, DATA_ONLY_YN
		 		, SCHEMA_ONLY_YN
		 		, NO_OWNER_YN
		 		, NO_PRIVILEGES_YN
		 		, NO_TABLESPACES_YN
		 		, CREATE_YN
		 		, CLEAN_YN
		 		, SINGLE_TRANSACTION_YN
		 		, DISABLE_TRIGGERS_YN
		 		, NO_DATA_FOR_FAILED_TABLES_YN
		 		, VERBOSE_YN
		 		, USE_SET_SESSON_AUTH_YN
		 		, EXIT_ON_ERROR_YN
		 		, REGR_ID
		 		)
		 		VALUES
		 		(
		 		nextval('Q_DUMP_RESTORE_01')
		 		, #{db_svr_id}
		 		, #{restore_nm}
		 		, #{restore_exp}
		 		, #{wrk_id}
		 		, #{wrkexe_sn}
				, #{restore_cndt}
				, #{format}
		 		, #{filename}
				, #{jobs}
				, #{role}
				, #{pre_data_yn}
				, #{data_yn}
		 		, #{post_data_yn}
		 		, #{data_only_yn}	
		 		, #{schema_only_yn}
				, #{no_owner_yn}
		 		, #{no_privileges_yn}
		 		, #{no_tablespaces_yn}	
		 		, #{create_yn}
				, #{clean_yn}
		 		, #{single_transaction_yn}
		 		, #{disable_triggers_yn}	
		 		, #{no_data_for_failed_tables_yn}
				, #{verbose_yn}
		 		, #{use_set_sesson_auth_yn}
		 		, #{exit_on_error_yn}	
		 		, #{regr_id}
		 		)
		</insert>	    
		
		<select id="latestDumpRestoreSN"  resultType="restoreDumpVO">
			/**
			* Query ID : latestDumpRestoreSN
			* Description : 최근SN 조회
			* Author : 변승우
			**/
			SELECT
				COALESCE(MAX(RESTORE_SN),0) AS restore_sn
			FROM
			T_DUMP_RESTORE
		</select>				
</mapper>
