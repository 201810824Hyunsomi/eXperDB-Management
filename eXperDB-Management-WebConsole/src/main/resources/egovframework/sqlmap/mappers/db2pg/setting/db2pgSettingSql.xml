<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="db2pgSettingSql">

    <select id="selectCode" resultType="codeVO" parameterType="String">
    	/**
	 	* Query ID : selectCode
	 	* Description : 공통 코드 조회
	 	* Author : 김주영
	 	**/
    	SELECT grp_cd, sys_cd, SYS_CD_NM
	 	FROM T_SYSDTL_C 
	 	where GRP_CD = #{grp_cd}
    </select>
    
	<select id="selectDDLWork" resultType="ddlConfigVO" parameterType="hashmap">
		/**
	 	*  Query ID : selectDDLWork
	 	*  Description : DDL 작업 정보 조회
	 	*  Author : 김주영
	 	**/		
		SELECT 
			(row_number() over()) as rownum
			, (row_number() over()) as idx
			, ddl_wrk_inf.db2pg_ddl_wrk_id
			, ddl_wrk_inf.db2pg_ddl_wrk_nm
			, ddl_wrk_inf.db2pg_ddl_wrk_exp
			, sys_inf.dbms_dscd
			, sys_inf.ipadr
			, sys_inf.dtb_nm
			, sys_inf.scm_nm
			, ddl_wrk_inf.frst_regr_id
			, TO_CHAR(ddl_wrk_inf.frst_reg_dtm,'YYYY-MM-DD HH24:MI') as frst_reg_dtm
			, ddl_wrk_inf.lst_mdfr_id
			, TO_CHAR(ddl_wrk_inf.lst_mdf_dtm,'YYYY-MM-DD HH24:MI') as lst_mdf_dtm 
		FROM t_db2pg_ddl_wrk_inf ddl_wrk_inf, t_db2pg_sys_inf sys_inf
		WHERE ddl_wrk_inf.db2pg_sys_id = sys_inf.db2pg_sys_id
		AND ddl_wrk_inf.db2pg_ddl_wrk_nm LIKE #{wrk_nm}
		AND sys_inf.dbms_dscd LIKE #{dbms_dscd}
		AND sys_inf.ipadr LIKE #{ipadr}
		AND sys_inf.dtb_nm LIKE #{dtb_nm}
		AND sys_inf.scm_nm LIKE #{scm_nm}
	</select>
	
	<select id="selectDataWork" resultType="dataConfigVO" parameterType="hashmap">
		/**
	 	*  Query ID : selectDataWork
	 	*  Description : Data 작업 정보 조회
	 	*  Author : 김주영
	 	**/
	 		SELECT 
			(row_number() over()) as rownum
			, (row_number() over()) as idx
			, trsf_wrk_inf.db2pg_trsf_wrk_id
			, trsf_wrk_inf.db2pg_trsf_wrk_nm
			, trsf_wrk_inf.db2pg_trsf_wrk_exp
			, source_sys_inf.dbms_dscd as source_dbms_dscd
			, source_sys_inf.ipadr as source_ipadr
			, source_sys_inf.dtb_nm as source_dtb_nm
			, source_sys_inf.scm_nm as source_scm_nm
			, target_sys_inf.dbms_dscd as target_dbms_dscd
			, target_sys_inf.ipadr as target_ipadr
			, target_sys_inf.dtb_nm as target_dtb_nm
			, target_sys_inf.scm_nm as target_scm_nm
			, trsf_wrk_inf.frst_regr_id
			, TO_CHAR(trsf_wrk_inf.frst_reg_dtm,'YYYY-MM-DD HH24:MI') as frst_reg_dtm
			, trsf_wrk_inf.lst_mdfr_id
			, TO_CHAR(trsf_wrk_inf.lst_mdf_dtm,'YYYY-MM-DD HH24:MI') as lst_mdf_dtm 
		FROM t_db2pg_trsf_wrk_inf trsf_wrk_inf 
		LEFT OUTER JOIN t_db2pg_sys_inf source_sys_inf ON trsf_wrk_inf.db2pg_source_system_id = source_sys_inf.db2pg_sys_id
		LEFT OUTER JOIN t_db2pg_sys_inf target_sys_inf ON trsf_wrk_inf.db2pg_trg_sys_id = target_sys_inf.db2pg_sys_id
		WHERE trsf_wrk_inf.db2pg_trsf_wrk_nm LIKE #{wrk_nm}
		<if test="data_dbms_dscd.equals('source_system')">
			AND source_sys_inf.dbms_dscd LIKE #{dbms_dscd}
			AND source_sys_inf.ipadr LIKE #{ipadr}
			AND source_sys_inf.dtb_nm LIKE #{dtb_nm}
			AND source_sys_inf.scm_nm LIKE #{scm_nm}	
		</if>
		<if test="data_dbms_dscd.equals('target_system')">
			AND target_sys_inf.dbms_dscd LIKE #{dbms_dscd}
			AND target_sys_inf.ipadr LIKE #{ipadr}
			AND target_sys_inf.dtb_nm LIKE #{dtb_nm}
			AND target_sys_inf.scm_nm LIKE #{scm_nm}
		</if>
	 </select>	
	
	<select id="selectExrttrgSrctblsSeq" resultType="int">
		/**
	 	*  Query ID : selectExrttrgSrctblsSeq
	 	*  Description : 추출 대상 테이블 작업 ID SEQ 조회
	 	*  Author : 김주영
	 	**/		
	 	SELECT setval('q_db2pg_exrttrg_srctb_ls_01',nextval('q_db2pg_exrttrg_srctb_ls_01'))
	</select>
	
	<select id="selectExrtexctSrctblsSeq" resultType="int">
		/**
	 	*  Query ID : selectExrtexctSrctblsSeq
	 	*  Description : 추출 제외 테이블 작업 ID SEQ 조회
	 	*  Author : 김주영
	 	**/		
	 	SELECT setval('q_db2pg_exrtexct_srctb_ls_01',nextval('q_db2pg_exrtexct_srctb_ls_01'))
	</select>

	<insert id="insertExrttrgSrcTb" parameterType="srcTableVO">
		/**
		* Query ID : insertExrttrgSrcTb
		* Description : 추출 대상 테이블 등록
		* Author : 김주영
		**/
		INSERT INTO t_db2pg_exrttrg_srctb_ls
		(
		  db2pg_exrt_trg_tb_wrk_id
		, exrt_trg_tb_nm 
		, exrt_trg_scm_nm
		, frst_regr_id
		, frst_reg_dtm
		)
		VALUES 
		(
		  #{db2pg_exrt_trg_tb_wrk_id}
		, #{exrt_trg_tb_nm}
		, #{exrt_trg_scm_nm}
		, #{frst_regr_id}
		, clock_timestamp()
		)
	</insert>
	
	<insert id="insertExrtexctSrcTb" parameterType="srcTableVO">
		/**
		* Query ID : insertExrtexctSrcTb
		* Description : 추출 제외 테이블 등록
		* Author : 김주영
		**/
		INSERT INTO t_db2pg_exrtexct_srctb_ls
		(
		  db2pg_exrt_exct_tb_wrk_id
		, exrt_exct_tb_nm 
		, exrt_exct_scm_nm
		, frst_regr_id
		, frst_reg_dtm
		)
		VALUES
		(
		  #{db2pg_exrt_exct_tb_wrk_id}
		, #{exrt_exct_tb_nm} 
		, #{exrt_exct_scm_nm}
		, #{frst_regr_id}
		, clock_timestamp()
		)
	</insert>
	
	<insert id="insertDDLWork" parameterType="ddlConfigVO">
		/**
		* Query ID : insertDDLWork
		* Description : DDL WORK 등록
		* Author : 김주영
		**/

		INSERT INTO t_db2pg_ddl_wrk_inf
		(
		  db2pg_ddl_wrk_id
		, db2pg_ddl_wrk_nm
		, db2pg_ddl_wrk_exp
		, db2pg_sys_id
		, db2pg_uchr_lchr_val
		, src_tb_ddl_exrt_tf
		, ddl_save_pth
		<if test="db2pg_exrt_trg_tb_wrk_id != 0">
		, db2pg_exrt_trg_tb_wrk_id
		</if>
		<if test="db2pg_exrt_exct_tb_wrk_id != 0">
		, db2pg_exrt_exct_tb_wrk_id
		</if>
		, frst_regr_id
		, frst_reg_dtm
		, lst_mdfr_id
		, lst_mdf_dtm
		)
		VALUES
		(
		  nextval('q_db2pg_ddl_wrk_inf_01')
		, #{db2pg_ddl_wrk_nm}
		, #{db2pg_ddl_wrk_exp}
		, #{db2pg_sys_id}
		, #{db2pg_uchr_lchr_val}
		, #{src_tb_ddl_exrt_tf}
		, #{ddl_save_pth}
		<if test="db2pg_exrt_trg_tb_wrk_id != 0">
		, #{db2pg_exrt_trg_tb_wrk_id}
		</if>
		<if test="db2pg_exrt_exct_tb_wrk_id != 0">
		, #{db2pg_exrt_exct_tb_wrk_id}
		</if>
		, #{frst_regr_id}
		, clock_timestamp()
		, #{lst_mdfr_id}
		, clock_timestamp()
		)
	</insert>
	
	<insert id="insertDataWork" parameterType="dataConfigVO">
		/**
		* Query ID : insertDataWork
		* Description : Data WORK 등록
		* Author : 김주영
		**/	
		INSERT INTO t_db2pg_trsf_wrk_inf
		(
		  db2pg_trsf_wrk_id
		, db2pg_trsf_wrk_nm
		, db2pg_trsf_wrk_exp
		, db2pg_source_system_id
		, db2pg_trg_sys_id
		, exrt_dat_cnt
		<if test="db2pg_exrt_trg_tb_wrk_id != 0">
		, db2pg_exrt_trg_tb_wrk_id
		</if>
		<if test="db2pg_exrt_exct_tb_wrk_id != 0">
		, db2pg_exrt_exct_tb_wrk_id
		</if>
		, exrt_dat_ftch_sz
		, dat_ftch_bff_sz
		, exrt_prl_prcs_ecnt
		, lob_dat_bff_sz
		, usr_qry_use_tf
		<if test="db2pg_usr_qry_id != 0">
		, db2pg_usr_qry_id
		</if>
		, ins_opt_cd 
		, tb_rbl_tf
		, cnst_cnd_exrt_tf
		, frst_regr_id
		, frst_reg_dtm
		, lst_mdfr_id
		, lst_mdf_dtm
		)
		VALUES
		(
		  nextval('q_db2pg_trsf_wrk_inf_01')
		, #{db2pg_trsf_wrk_nm}
		, #{db2pg_trsf_wrk_exp}
		, #{db2pg_source_system_id}
		, #{db2pg_trg_sys_id}
		, #{exrt_dat_cnt}
		<if test="db2pg_exrt_trg_tb_wrk_id != 0">
		, #{db2pg_exrt_trg_tb_wrk_id}
		</if>
		<if test="db2pg_exrt_exct_tb_wrk_id != 0">
		, #{db2pg_exrt_exct_tb_wrk_id}
		</if>
		, #{exrt_dat_ftch_sz}
		, #{dat_ftch_bff_sz}
		, #{exrt_prl_prcs_ecnt}
		, #{lob_dat_bff_sz}
		, #{usr_qry_use_tf}
		<if test="db2pg_usr_qry_id != 0">
		, #{db2pg_usr_qry_id}
		</if>
		, #{ins_opt_cd}
		, #{tb_rbl_tf}
		, #{cnst_cnd_exrt_tf}
		, #{frst_regr_id}
		, clock_timestamp()
		, #{lst_mdfr_id}
		, clock_timestamp()
		)		
	</insert>
	
	<update id="updateDDLWork" parameterType="ddlConfigVO">
		/**
		* Query ID : updateDDLWork
		* Description : DDL WORK 수정
		* Author : 김주영
		**/
 		UPDATE t_db2pg_ddl_wrk_inf
		SET 
		  db2pg_ddl_wrk_exp=#{db2pg_ddl_wrk_exp}
		, db2pg_sys_id=#{db2pg_sys_id}
		, db2pg_uchr_lchr_val=#{db2pg_uchr_lchr_val}
		, src_tb_ddl_exrt_tf=#{src_tb_ddl_exrt_tf}
		, ddl_save_pth=#{ddl_save_pth}
		<if test="db2pg_exrt_trg_tb_wrk_id != 0">
		, db2pg_exrt_trg_tb_wrk_id=#{db2pg_exrt_trg_tb_wrk_id}
		</if>
		<if test="db2pg_exrt_exct_tb_wrk_id != 0">
		, db2pg_exrt_exct_tb_wrk_id=#{db2pg_exrt_exct_tb_wrk_id}
		</if>
		, lst_mdfr_id=#{lst_mdfr_id}
		, lst_mdf_dtm= clock_timestamp()
		WHERE db2pg_ddl_wrk_id = #{db2pg_ddl_wrk_id}
	</update>
		
	<select id="selectDetailDDLWork" resultType="ddlConfigVO" parameterType="int">
		/**
		* Query ID : selectDetailDDLWork
		* Description : DDL WORK 상세정보
		* Author : 김주영
		**/
		SELECT 
			  db2pg_ddl_wrk_id
			, db2pg_ddl_wrk_nm
			, db2pg_ddl_wrk_exp
			, db2pg_uchr_lchr_val
			, src_tb_ddl_exrt_tf
			, ddl_save_pth
			, db2pg_sys_id
			, (SELECT db2pg_sys_nm FROM t_db2pg_sys_inf WHERE db2pg_sys_id=wrk_inf.db2pg_sys_id) as db2pg_sys_nm
			, (SELECT exrt_trg_tb_nm FROM t_db2pg_exrttrg_srctb_ls WHERE db2pg_exrt_trg_tb_wrk_id=wrk_inf.db2pg_exrt_trg_tb_wrk_id) as exrt_trg_tb_nm
			, coalesce((SELECT length(exrt_trg_tb_nm)-length(replace(exrt_trg_tb_nm,',',''))+1 FROM t_db2pg_exrttrg_srctb_ls WHERE db2pg_exrt_trg_tb_wrk_id=wrk_inf.db2pg_exrt_trg_tb_wrk_id),0) as exrt_trg_tb_cnt
			, (SELECT exrt_exct_tb_nm FROM t_db2pg_exrtexct_srctb_ls WHERE db2pg_exrt_exct_tb_wrk_id=wrk_inf.db2pg_exrt_exct_tb_wrk_id) as exrt_exct_tb_nm
			, coalesce((SELECT length(exrt_exct_tb_nm)-length(replace(exrt_exct_tb_nm,',',''))+1 FROM t_db2pg_exrtexct_srctb_ls WHERE db2pg_exrt_exct_tb_wrk_id=wrk_inf.db2pg_exrt_exct_tb_wrk_id),0) as exrt_exct_tb_cnt
		FROM t_db2pg_ddl_wrk_inf wrk_inf
		WHERE db2pg_ddl_wrk_id=#{db2pg_ddl_wrk_id}
	</select>
	
	<select id="selectSoruceDBMS" resultType="db2pgSysInfVO" parameterType="int">
		/**
		* Query ID : selectSoruceDBMS
		* Description : 소스DBMS 접속정보
		* Author : 김주영
		**/
		SELECT 
			  db2pg_sys_id
			, db2pg_sys_nm
			, case when dbms_dscd ='TC002201' then 'ORA' 
				when dbms_dscd ='TC002202' then 'MSS'
				when dbms_dscd ='TC002203' then 'MYS'
				when dbms_dscd ='TC002204' then 'POG'
				when dbms_dscd ='TC002205' then 'DB2'
				when dbms_dscd ='TC002206' then 'ASE'
				when dbms_dscd ='TC002207' then 'CUB'
				when dbms_dscd ='TC002208' then 'TBR'
				end as dbms_dscd
			, ipadr
			, dtb_nm
			, spr_usr_id
			, portno
			, scm_nm
			, pwd
			, (SELECT sys_cd_nm FROM t_sysdtl_c WHERE sys_cd=sys_inf.crts_nm) as crts_nm
		FROM t_db2pg_sys_inf sys_inf
		WHERE db2pg_sys_id=#{db2pg_sys_id}
	</select>
</mapper>
