<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="experdbBackupSql">
	<select id="getServerInfo" resultType="serverInfoVO">
		<!-- select 
		    db_svr_id as dbSvrId
		  , master_gbn as masterGbn
		  , ipadr as ipadr 
		  , portno as portno 
		  , svr_host_nm as hostName 
		from t_dbsvripadr_i a
		inner join (
		    select 
			   distinct db_svr_id as id
			from t_usrdbaut_i
			where 1=1
			  and usr_id like #{userId}
			  and aut_yn = 'Y'
		) b
		on a.db_svr_id = b.id order by db_svr_id, master_gbn -->
		
		SELECT
		    db_svr_id as dbSvrId
		  , master_gbn as masterGbn
		  , ipadr as ipadr 
		  , portno as portno 
		  , svr_host_nm as hostName 
		FROM t_dbsvripadr_i 
		ORDER BY db_svr_id , master_gbn
	</select>
	

	<select id="getNodeList" parameterType="targetMachineVO" resultType="targetMachineVO">
				SELECT
						name,
						user,
						password,
						operatingsystem,
						description,
						isprotected,
						jobname,
						licensestatus,
						connectionstatus,
						lastresult,
						recoverypointcount,
						recoverysetcount,
						excludevolumes,
						backuplocationtype,
						machinetype,
						uuid
				FROM TARGETMACHINE
				WHERE 1 =1
		</select>
		
		<select id="backupStorageList" resultType="backupLocationInfoVO">
				SELECT 
				        "location" as backupDestLocation
				      , "type" as "type"
				      , "free" as freeSize
				      , total as totalSize
				      , currentjobcount as currentJobCount
				      , waitingjobcount as waitingJobCount
			      FROM  backuplocation
			
		</select>
		
		<insert id="backupStorageInsert" parameterType="backupLocationInfoVO">
			INSERT INTO backuplocation 
			( 
			    uuid
			  , "location"
			  <if test="type == 2">
			  , username
			  , "password"
			  </if>
			  , "free"
			  , total
			  , "type"
			  , isrunscript
			  , freealert
			  , freealertunit
			  , joblimit
			  , "time"
			  , currentjobcount
			  , waitingjobcount
			  , rpsport
			  , enablededup
			 )
			 VALUES 
			 (
		    	  #{uuid}
		    	, #{backupDestLocation}
		    	<if test="type == 2">
		    	, #{backupDestUser}
		    	, #{backupDestPasswd}
		    	</if>
		    	, #{freeSize}
		    	, #{totalSize}
		    	, #{type}
		    	, #{isRunScript}
		    	, #{freeSizeAlert}
		    	, #{freeSizeAlertUnit}
		    	, #{jobLimit}
		    	, #{time}
		    	, #{currentJobCount}
		    	, #{waitingJobCount}
		    	, 0
		    	, 0
     		)
		</insert>
		
		<select id="backupStorageInfo" parameterType="backupLocationInfoVO" resultType="backupLocationInfoVO">
			SELECT 
			     "location" as backupDestLocation
			   , username as backupDestUser
			   , "password" as backupDestPasswd
			   , isrunscript as isRunScript 
			   , joblimit as jobLimit 
			   , freealert as freeSizeAlert
			   , freealertunit as freeSizeAlertUnit
			   , "type" as "type"
			FROM
			   backuplocation b2 
			WHERE "location" like #{backupDestLocation}
			    
		</select>
		
		<update id="backupStorageUpdate" parameterType="backupLocationInfoVO">
			UPDATE backuplocation
			   SET isrunscript = #{isRunScript}
		       <if test="type == 2">
				  , username = #{backupDestUser}
				  , "password" = #{backupDestPasswd}
			   </if>
			      , joblimit = #{jobLimit}
			      , freealert = #{freeSizeAlert}
			      , freealertunit = #{freeSizeAlertUnit}
			 WHERE "location" like #{backupDestLocation}		       
			
		</update>
		
		<delete id="backupStorageDelete" parameterType="backupLocationInfoVO">
			 DELETE FROM backuplocation WHERE "location" like #{backupDestLocation}
		</delete>
		
		<select id="getNodeInfo" resultType="targetMachineVO" parameterType="String">
			SELECT 
			    "name" AS "name"
			  , "User" AS "user"
			  , description
			  FROM targetmachine
		     WHERE "name" like #{path}
		</select>
</mapper>